<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Customer Feedback Analyzer</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header>
    <h1>Customer Feedback Analyzer</h1>
    <p>Sentiment • Star Rating • Emotion</p>
  </header>

  <main>
    <!-- Input form -->
    <section class="card">
      <form action="/analyze" method="post" enctype="multipart/form-data" class="grid">
        <div class="form-group">
          <label>Enter a single feedback (text)</label>
          <textarea name="text" placeholder="Type or paste customer feedback here..."></textarea>
        </div>
        <div class="or">— or —</div>
        <div class="form-group">
          <label>Upload CSV (any delimiter; malformed rows auto-skipped)</label>
          <input type="file" name="file" accept=".csv"/>
        </div>
        <button class="btn" type="submit">Analyze</button>
        <!--<a class="link" href="/json" target="_blank">JSON API quick start</a>-->
      </form>

      {% if messages %}
        <ul class="messages">
          {% for m in messages %}
            <li>{{ m }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </section>

    <!-- Results -->
    {% if results is not none and results %}
    <section class="card">
      <details open>
        <summary>Show Results ({{ results|length }})</summary>
        <div style="margin:10px 0;">
          <!--<a class="btn" href="/download/results.json">Download JSON (pretty)</a>-->
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Text</th>
                <th>Sentiment</th>
                <th>Confidence</th>
                <th>Rating</th>
                <th>Emotion</th>
                <!--<th>Top-3 Emotions</th>-->
              </tr>
            </thead>
            <tbody>
              {% for r in results %}
              <tr>
                <td>{{ loop.index }}</td>
                <td class="text-cell">{{ r.text }}</td>
                <td><span class="pill">{{ r.sentiment }}</span></td>
                <td>{{ "%.2f"|format(r.sentiment_score*100) }}%</td>
                <td>
                  {{ r.stars_display }}
                  {% if r.rating_stars %}<small>({{ r.rating_stars }}/5)</small>{% endif %}
                </td>
                <td>
                  <span class="pill emo">{{ r.emotion_emoji }} {{ r.emotion_label }}</span>
                  <small>{{ "%.2f"|format(r.emotion_score*100) }}%</small>
                </td>
                <td class="dist">
                  {% for lbl, prob in r.emotion_top3 %}
                    <span class="dist-chip">{{ lbl.capitalize() }}</span> {{ "%.0f"|format(prob*100) }}{% if not loop.last %}, {% endif %}
                  {% endfor %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </section>
    {% endif %}

    <!-- Recent feed -->
    <section class="card">
      <details {% if not results %}open{% endif %}>
        <summary>Recent Feed (saved until the app restarts) — {{ recent|length }}</summary>
        <form action="/recent/clear" method="post" style="margin:10px 0;">
          <button class="btn" type="submit">Clear Recent</button>
          <a class="link" style="margin-left:12px;" href="/api/recent" target="_blank">View as JSON</a>
          <a class="link" style="margin-left:12px;" href="/download/recent.json">Download JSON</a>
        </form>
        {% if recent and recent|length > 0 %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>Text</th>
                <th>Sentiment</th>
                <th>Rating</th>
                <th>Emotion</th>
              </tr>
            </thead>
            <tbody>
              {% for r in recent %}
              <tr>
                <td>{{ r.ts }}</td>
                <td class="text-cell">{{ r.text }}</td>
                <td>
                  <span class="pill">{{ r.sentiment }}</span>
                  <small>({{ "%.0f"|format(r.sentiment_score*100) }}%)</small>
                </td>
                <td>
                  {{ r.stars_display }}
                  {% if r.rating_stars %}<small>({{ r.rating_stars }}/5)</small>{% endif %}
                </td>
                <td>
                  <span class="pill emo">{{ r.emotion_emoji }} {{ r.emotion_label }}</span>
                  <small>({{ "%.0f"|format(r.emotion_score*100) }}%)</small>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <p class="muted">No recent items yet.</p>
        {% endif %}
      </details>
    </section>

  </main>

<footer style="text-align:center; padding:10px; font-size:0.9em;">
  <small>
    K. Yuva Sree &nbsp;|&nbsp; V. Varshini <br>
    AI & Cyber Security Dept.
  </small>
</footer>

</body>
</html>
